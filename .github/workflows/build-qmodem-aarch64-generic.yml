name: Build COMPLETE QModem stack for aarch64_generic

on:
  workflow_dispatch:

env:
  SDK_URL: https://downloads.openwrt.org/releases/24.10.5/targets/armsr/armv8/openwrt-sdk-24.10.5-armsr-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev python3 python3-distutils rsync \
            unzip zlib1g-dev file wget curl zstd ca-certificates patch \
            pkgconf ccache xz-utils

      - name: Download OpenWrt SDK
        run: |
          wget -O openwrt-sdk.tar.zst "$SDK_URL"
          tar --use-compress-program=unzstd -xf openwrt-sdk.tar.zst
          mv openwrt-sdk-* sdk
          test -d sdk

      - name: Update default feeds
        working-directory: ./sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add QModem feed
        working-directory: ./sdk
        run: |
          echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          ./scripts/feeds update qmodem
          ./scripts/feeds install -a -f -p qmodem
          echo "=== package/feeds/qmodem ==="
          ls -lah package/feeds/qmodem || true

      - name: Prepare build config
        working-directory: ./sdk
        run: |
          cat > .config << 'EOF'
          CONFIG_ALL=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL_NONSHARED=n
          CONFIG_DEVEL=n
          CONFIG_CCACHE=y

          # known core
          CONFIG_PACKAGE_bc=m
          CONFIG_PACKAGE_qmodem=m
          CONFIG_PACKAGE_luci-app-qmodem=m
          CONFIG_PACKAGE_luci-app-qmodem-next=m
          CONFIG_PACKAGE_luci-app-qmodem-sms=m
          CONFIG_PACKAGE_luci-app-qmodem-mwan=m
          CONFIG_PACKAGE_luci-app-qmodem-ttl=m

          # helpers / runtime
          CONFIG_PACKAGE_sms-tool_q=m
          CONFIG_PACKAGE_tom_modem=m
          CONFIG_PACKAGE_ndisc6=m
          CONFIG_PACKAGE_rdisc6=m
          CONFIG_PACKAGE_ubus-at-daemon=m
          CONFIG_PACKAGE_quectel-CM-5G-M=m
          CONFIG_PACKAGE_sms-forwarder=m
          CONFIG_PACKAGE_sms-forwarder-next=m

          # driver outputs (if recipe present)
          CONFIG_PACKAGE_kmod-qmi_wwan_f=m
          CONFIG_PACKAGE_kmod-qmi_wwan_q=m
          CONFIG_PACKAGE_kmod-qmi_wwan_s=m
          EOF
          make defconfig

      - name: Mark build start time
        run: |
          touch /tmp/qmodem_build_start

      - name: Build bc first
        working-directory: ./sdk
        run: |
          set -e
          if [ -d "package/feeds/packages/bc" ] && [ -f "package/feeds/packages/bc/Makefile" ]; then
            make package/feeds/packages/bc/compile V=s -j1
          else
            echo "bc package dir not found in feeds/packages"
            exit 1
          fi

      - name: Build all known QModem package dirs
        working-directory: ./sdk
        run: |
          set -e

          build_if_exists() {
            local pkg="$1"
            if [ -d "package/feeds/qmodem/$pkg" ] && [ -f "package/feeds/qmodem/$pkg/Makefile" ]; then
              echo "========================================"
              echo "Compiling known package dir: $pkg"
              echo "========================================"
              make "package/feeds/qmodem/$pkg/compile" V=s -j1
            else
              echo "SKIP (dir not found): $pkg"
            fi
          }

          # core UIs
          build_if_exists qmodem
          build_if_exists luci-app-qmodem
          build_if_exists luci-app-qmodem-next
          build_if_exists luci-app-qmodem-sms
          build_if_exists luci-app-qmodem-mwan
          build_if_exists luci-app-qmodem-ttl
          build_if_exists luci-app-qmodem-hc

          # helpers
          build_if_exists sms-tool_q
          build_if_exists tom_modem
          build_if_exists ndisc6
          build_if_exists ubus_at_daemon
          build_if_exists quectel_CM_5G_M
          build_if_exists sms_forwarder
          build_if_exists sms_forwarder_next

          # driver recipes
          build_if_exists fibocom_QMI_WWAN
          build_if_exists quectel_QMI_WWAN
          build_if_exists simcom_QMI_WWAN

      - name: Build any remaining qmodem feed dirs automatically
        working-directory: ./sdk
        run: |
          set -e

          KNOWN_DIRS="
          qmodem
          luci-app-qmodem
          luci-app-qmodem-next
          luci-app-qmodem-sms
          luci-app-qmodem-mwan
          luci-app-qmodem-ttl
          luci-app-qmodem-hc
          sms-tool_q
          tom_modem
          ndisc6
          ubus_at_daemon
          quectel_CM_5G_M
          sms_forwarder
          sms_forwarder_next
          fibocom_QMI_WWAN
          quectel_QMI_WWAN
          simcom_QMI_WWAN
          "

          for d in package/feeds/qmodem/*; do
            [ -d "$d" ] || continue
            [ -f "$d/Makefile" ] || continue
            pkg="$(basename "$d")"

            if echo " $KNOWN_DIRS " | grep -q " $pkg "; then
              continue
            fi

            echo "========================================"
            echo "Compiling extra discovered dir: $pkg"
            echo "========================================"
            make "package/feeds/qmodem/$pkg/compile" V=s -j1
          done

      - name: Collect ALL newly built IPKs
        run: |
          mkdir -p output
          find sdk/bin/packages -type f -name "*.ipk" | sort > output/ipk-list-all.txt
          find sdk/bin/packages -type f -name "*.ipk" -newer /tmp/qmodem_build_start -exec cp -v {} output/ \;
          echo "=== collected files ==="
          ls -lah output

      - name: Verify critical packages exist
        run: |
          ls output/qmodem_*.ipk
          ls output/luci-app-qmodem_*.ipk
          ls output/sms-tool_q_*.ipk
          ls output/tom_modem_*.ipk
          ls output/ndisc6_*.ipk
          ls output/rdisc6_*.ipk
          ls output/ubus-at-daemon_*.ipk
          ls output/quectel-CM-5G-M_*.ipk
          ls output/sms-forwarder_*.ipk

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qmodem-aarch64-generic-complete
          path: |
            output/*
          if-no-files-found: error
