name: Build Full QModem for aarch64_generic

on:
  workflow_dispatch:

env:
  SDK_URL: https://downloads.openwrt.org/releases/24.10.5/targets/armsr/armv8/openwrt-sdk-24.10.5-armsr-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses5-dev libssl-dev python3 python3-distutils rsync \
            unzip zlib1g-dev file wget curl zstd ca-certificates patch \
            pkgconf ccache xz-utils

      - name: Download OpenWrt SDK
        run: |
          wget -O openwrt-sdk.tar.zst "$SDK_URL"
          tar --use-compress-program=unzstd -xf openwrt-sdk.tar.zst
          mv openwrt-sdk-* sdk
          test -d sdk

      - name: Update default feeds
        working-directory: ./sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add QModem feed
        working-directory: ./sdk
        run: |
          echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          ./scripts/feeds update qmodem
          ./scripts/feeds install -a -f -p qmodem

          echo "=== package/feeds/qmodem ==="
          ls -lah package/feeds/qmodem || true

      - name: Prepare full config
        working-directory: ./sdk
        run: |
          cat > .config << 'EOF'
          CONFIG_ALL=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL_NONSHARED=n
          CONFIG_DEVEL=n
          CONFIG_CCACHE=y

          # Core
          CONFIG_PACKAGE_qmodem=m
          CONFIG_PACKAGE_luci-app-qmodem=m
          CONFIG_PACKAGE_sms-tool_q=m
          CONFIG_PACKAGE_tom_modem=m
          CONFIG_PACKAGE_ndisc6=m
          CONFIG_PACKAGE_rdisc6=m
          CONFIG_PACKAGE_bc=y

          # Extra QModem components (if present in feed)
          CONFIG_PACKAGE_ubus-at-daemon=m
          CONFIG_PACKAGE_ubus_at_daemon=m
          CONFIG_PACKAGE_quectel-CM-5G-M=m
          CONFIG_PACKAGE_quectel_CM_5G_M=m
          CONFIG_PACKAGE_sms-forwarder=m
          CONFIG_PACKAGE_sms_forwarder=m

          # QMI driver packages (if present)
          CONFIG_PACKAGE_kmod-qmi_wwan_f=m
          CONFIG_PACKAGE_kmod-qmi_wwan_q=m
          CONFIG_PACKAGE_kmod-qmi_wwan_s=m

          # Optional LuCI variants (if present)
          CONFIG_PACKAGE_luci-app-qmodem-next=m
          CONFIG_PACKAGE_luci-app-qmodem-sms=m
          CONFIG_PACKAGE_luci-app-qmodem-mwan=m
          CONFIG_PACKAGE_luci-app-qmodem-ttl=m
          EOF
          make defconfig

      - name: Compile full QModem stack
        working-directory: ./sdk
        run: |
          set -e

          build_if_exists() {
            local pkg="$1"
            if [ -d "package/feeds/qmodem/$pkg" ] && [ -f "package/feeds/qmodem/$pkg/Makefile" ]; then
              echo "========================================"
              echo "Compiling: $pkg"
              echo "========================================"
              make "package/feeds/qmodem/$pkg/compile" V=s -j1
            else
              echo "SKIP (not found in feed): $pkg"
            fi
          }

          # Core
          build_if_exists qmodem
          build_if_exists luci-app-qmodem
          build_if_exists sms-tool_q
          build_if_exists tom_modem
          build_if_exists ndisc6

          # Runtime helpers / extras
          build_if_exists ubus_at_daemon
          build_if_exists quectel_CM_5G_M
          build_if_exists sms_forwarder

          # QMI driver recipe dirs (these usually emit kmod-qmi_wwan_*.ipk)
          build_if_exists fibocom_QMI_WWAN
          build_if_exists quectel_QMI_WWAN
          build_if_exists simcom_QMI_WWAN

          # Optional LuCI variants
          build_if_exists luci-app-qmodem-next
          build_if_exists luci-app-qmodem-sms
          build_if_exists luci-app-qmodem-mwan
          build_if_exists luci-app-qmodem-ttl

      - name: Collect QModem-related IPKs
        run: |
          mkdir -p output

          find sdk/bin/packages -type f -name "*.ipk" | sort | tee output/ipk-list.txt

          find sdk/bin/packages -type f -name "*.ipk" \
            \( -name "qmodem*.ipk" -o \
               -name "luci-app-qmodem*.ipk" -o \
               -name "sms-tool_q*.ipk" -o \
               -name "tom_modem*.ipk" -o \
               -name "ndisc6*.ipk" -o \
               -name "rdisc6*.ipk" -o \
               -name "ubus-at-daemon*.ipk" -o \
               -name "ubus_at_daemon*.ipk" -o \
               -name "quectel-CM-5G-M*.ipk" -o \
               -name "quectel_CM_5G_M*.ipk" -o \
               -name "sms-forwarder*.ipk" -o \
               -name "sms_forwarder*.ipk" -o \
               -name "kmod-qmi_wwan_f*.ipk" -o \
               -name "kmod-qmi_wwan_q*.ipk" -o \
               -name "kmod-qmi_wwan_s*.ipk" -o \
               -name "luci-app-qmodem-next*.ipk" -o \
               -name "luci-app-qmodem-sms*.ipk" -o \
               -name "luci-app-qmodem-mwan*.ipk" -o \
               -name "luci-app-qmodem-ttl*.ipk" \) \
            -exec cp -v {} output/ \;

          echo "=== output files ==="
          ls -lah output

      - name: Verify core full-stack IPKs exist
        run: |
          ls output/qmodem_*.ipk
          ls output/luci-app-qmodem_*.ipk
          ls output/sms-tool_q_*.ipk
          ls output/tom_modem_*.ipk
          ls output/ndisc6_*.ipk
          ls output/rdisc6_*.ipk

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: qmodem-aarch64-generic-ipk-full
          path: |
            output/*.ipk
            output/ipk-list.txt
          if-no-files-found: error
